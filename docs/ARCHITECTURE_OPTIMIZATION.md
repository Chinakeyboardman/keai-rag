# é«˜å¹¶å‘ä¸åˆ†å¸ƒå¼æ¶æ„ä¼˜åŒ–æ–¹æ¡ˆ

## ğŸ“‹ å½“å‰æ¶æ„åˆ†æ

### ç°çŠ¶ï¼šå•ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚         FastAPI å•ä½“åº”ç”¨                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ æ–‡æ¡£ä¸Šä¼   â”‚  â”‚  æŸ¥è¯¢æœåŠ¡ â”‚  â”‚  Web UI â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚         â”‚            â”‚            â”‚       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚    å…±äº«èµ„æºï¼ˆæ¨¡å‹ã€å‘é‡åº“ï¼‰          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ç“¶é¢ˆåˆ†æ

1. **èµ„æºç«äº‰**
   - Embeddingæ¨¡å‹å’ŒLLMæ¨¡å‹å…±äº«åŒä¸€è¿›ç¨‹
   - æ–‡æ¡£å¤„ç†å’ŒæŸ¥è¯¢è¯·æ±‚ç«äº‰CPU/GPUèµ„æº
   - å†…å­˜å ç”¨é«˜ï¼ˆæ¨¡å‹å¸¸é©»å†…å­˜ï¼‰

2. **æ‰©å±•æ€§å·®**
   - æ— æ³•ç‹¬ç«‹æ‰©å±•ä¸åŒæœåŠ¡
   - æ¨¡å‹æ¨ç†é˜»å¡APIå“åº”
   - å•ç‚¹æ•…éšœé£é™©

3. **å¹¶å‘é™åˆ¶**
   - å•è¿›ç¨‹å¤„ç†æ‰€æœ‰è¯·æ±‚
   - æ¨¡å‹æ¨ç†æ˜¯CPU/GPUå¯†é›†å‹ï¼Œé˜»å¡I/O
   - æ— æ³•å……åˆ†åˆ©ç”¨å¤šæ ¸/å¤šGPU

4. **éƒ¨ç½²å›°éš¾**
   - æ‰€æœ‰ç»„ä»¶è€¦åˆåœ¨ä¸€èµ·
   - æ— æ³•æŒ‰éœ€æ‰©å®¹
   - èµ„æºåˆ©ç”¨ç‡ä½

---

## ğŸ—ï¸ ä¼˜åŒ–æ–¹æ¡ˆä¸€ï¼šå¾®æœåŠ¡æ¶æ„

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API Gateway                           â”‚
â”‚                    (Kong / Nginx / Traefik)                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  æ–‡æ¡£æœåŠ¡     â”‚    â”‚  æŸ¥è¯¢æœåŠ¡     â”‚    â”‚  ç®¡ç†æœåŠ¡     â”‚
â”‚ Document API â”‚    â”‚  Query API   â”‚    â”‚  Admin API   â”‚
â”‚              â”‚    â”‚              â”‚    â”‚              â”‚
â”‚ - ä¸Šä¼ æ–‡æ¡£    â”‚    â”‚ - å¤„ç†æŸ¥è¯¢    â”‚    â”‚ - å¥åº·æ£€æŸ¥    â”‚
â”‚ - æ–‡æ¡£åˆ—è¡¨    â”‚    â”‚ - è¿”å›ç­”æ¡ˆ    â”‚    â”‚ - ç›‘æ§ç»Ÿè®¡    â”‚
â”‚ - åˆ é™¤æ–‡æ¡£    â”‚    â”‚ - é—®é¢˜æ¨è    â”‚    â”‚ - é…ç½®ç®¡ç†    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ Embedding    â”‚    â”‚   LLMæœåŠ¡     â”‚    â”‚  å‘é‡å­˜å‚¨     â”‚
â”‚   æœåŠ¡        â”‚    â”‚   LLM Service â”‚    â”‚ Vector Store â”‚
â”‚              â”‚    â”‚              â”‚    â”‚              â”‚
â”‚ - æ–‡æœ¬å‘é‡åŒ–  â”‚    â”‚ - ç”Ÿæˆç­”æ¡ˆ    â”‚    â”‚ - Qdranté›†ç¾¤  â”‚
â”‚ - æ‰¹é‡å¤„ç†    â”‚    â”‚ - é—®é¢˜æ¨è    â”‚    â”‚ - FAISS      â”‚
â”‚ - æ¨¡å‹ç¼“å­˜    â”‚    â”‚ - æµå¼è¾“å‡º    â”‚    â”‚ - å…ƒæ•°æ®DB    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
                    â”‚  æ¶ˆæ¯é˜Ÿåˆ—     â”‚
                    â”‚ Message Queueâ”‚
                    â”‚ (Redis/RabbitMQ)â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æœåŠ¡æ‹†åˆ†

#### 1. API Gatewayï¼ˆç½‘å…³æœåŠ¡ï¼‰
- **èŒè´£**ï¼šè·¯ç”±ã€è´Ÿè½½å‡è¡¡ã€è®¤è¯ã€é™æµ
- **æŠ€æœ¯**ï¼šKong / Nginx / Traefik
- **æ‰©å±•æ€§**ï¼šæ°´å¹³æ‰©å±•

#### 2. Document Serviceï¼ˆæ–‡æ¡£æœåŠ¡ï¼‰
- **èŒè´£**ï¼šæ–‡æ¡£ä¸Šä¼ ã€åˆ—è¡¨ã€åˆ é™¤
- **ç‰¹ç‚¹**ï¼šI/Oå¯†é›†å‹ï¼Œå¯ç‹¬ç«‹æ‰©å±•
- **æŠ€æœ¯æ ˆ**ï¼šFastAPI + Celeryï¼ˆå¼‚æ­¥ä»»åŠ¡ï¼‰

#### 3. Query Serviceï¼ˆæŸ¥è¯¢æœåŠ¡ï¼‰
- **èŒè´£**ï¼šå¤„ç†ç”¨æˆ·æŸ¥è¯¢è¯·æ±‚
- **ç‰¹ç‚¹**ï¼šåè°ƒå…¶ä»–æœåŠ¡ï¼Œè½»é‡çº§
- **æŠ€æœ¯æ ˆ**ï¼šFastAPI + gRPCå®¢æˆ·ç«¯

#### 4. Embedding Serviceï¼ˆå‘é‡åŒ–æœåŠ¡ï¼‰
- **èŒè´£**ï¼šæ–‡æœ¬å‘é‡åŒ–
- **ç‰¹ç‚¹**ï¼šCPU/GPUå¯†é›†å‹ï¼Œå¯å¤šå®ä¾‹
- **æŠ€æœ¯æ ˆ**ï¼šFastAPI + æ¨¡å‹æœåŠ¡
- **æ‰©å±•**ï¼šå¯éƒ¨ç½²å¤šä¸ªå®ä¾‹ï¼Œä½¿ç”¨è´Ÿè½½å‡è¡¡

#### 5. LLM Serviceï¼ˆå¤§æ¨¡å‹æœåŠ¡ï¼‰
- **èŒè´£**ï¼šç”Ÿæˆç­”æ¡ˆã€é—®é¢˜æ¨è
- **ç‰¹ç‚¹**ï¼šGPUå¯†é›†å‹ï¼Œèµ„æºæ¶ˆè€—å¤§
- **æŠ€æœ¯æ ˆ**ï¼švLLM / TensorRT-LLM / Ollama
- **æ‰©å±•**ï¼šGPUé›†ç¾¤ï¼Œæ¨¡å‹å¹¶è¡Œ

#### 6. Vector Storeï¼ˆå‘é‡å­˜å‚¨ï¼‰
- **èŒè´£**ï¼šå‘é‡æ•°æ®å­˜å‚¨å’Œæ£€ç´¢
- **æŠ€æœ¯**ï¼šQdranté›†ç¾¤ / Milvus / Weaviate
- **æ‰©å±•**ï¼šåˆ†å¸ƒå¼é›†ç¾¤

#### 7. Message Queueï¼ˆæ¶ˆæ¯é˜Ÿåˆ—ï¼‰
- **èŒè´£**ï¼šå¼‚æ­¥ä»»åŠ¡é˜Ÿåˆ—
- **æŠ€æœ¯**ï¼šRedis / RabbitMQ / Kafka
- **ç”¨é€”**ï¼šæ–‡æ¡£å¤„ç†ä»»åŠ¡é˜Ÿåˆ—

---

## ğŸš€ ä¼˜åŒ–æ–¹æ¡ˆäºŒï¼šåˆ†å¸ƒå¼éƒ¨ç½²

### éƒ¨ç½²æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     è´Ÿè½½å‡è¡¡å±‚ (Nginx)                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚  APIèŠ‚ç‚¹1     â”‚    â”‚  APIèŠ‚ç‚¹2     â”‚    â”‚  APIèŠ‚ç‚¹N     â”‚
â”‚ (Document)   â”‚    â”‚  (Query)     â”‚    â”‚  (Admin)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
        â”‚                   â”‚                   â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚                   â”‚                   â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
â”‚ Embedding    â”‚    â”‚   LLMèŠ‚ç‚¹     â”‚    â”‚  å‘é‡å­˜å‚¨     â”‚
â”‚ èŠ‚ç‚¹1-3      â”‚    â”‚  èŠ‚ç‚¹1-2      â”‚    â”‚  é›†ç¾¤        â”‚
â”‚ (CPU/GPU)    â”‚    â”‚  (GPU)       â”‚    â”‚  (Qdrant)    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å®¹å™¨åŒ–éƒ¨ç½²ï¼ˆDocker + Kubernetesï¼‰

#### Docker Compose æ–¹æ¡ˆï¼ˆé€‚åˆä¸­å°è§„æ¨¡ï¼‰

```yaml
# docker-compose.yml
version: '3.8'

services:
  # API Gateway
  nginx:
    image: nginx:alpine
    ports:
      - "80:80"
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    depends_on:
      - document-api
      - query-api

  # æ–‡æ¡£æœåŠ¡
  document-api:
    build: ./services/document
    ports:
      - "8001:8000"
    environment:
      - REDIS_URL=redis://redis:6379
      - VECTOR_STORE_URL=http://qdrant:6333
    depends_on:
      - redis
      - qdrant

  # æŸ¥è¯¢æœåŠ¡
  query-api:
    build: ./services/query
    ports:
      - "8002:8000"
    environment:
      - EMBEDDING_SERVICE_URL=http://embedding-service:8000
      - LLM_SERVICE_URL=http://llm-service:8000
      - VECTOR_STORE_URL=http://qdrant:6333
    depends_on:
      - embedding-service
      - llm-service
      - qdrant

  # EmbeddingæœåŠ¡ï¼ˆå¯å¤šå®ä¾‹ï¼‰
  embedding-service:
    build: ./services/embedding
    ports:
      - "8003:8000"
    deploy:
      replicas: 3  # 3ä¸ªå®ä¾‹
    environment:
      - MODEL_PATH=/models/embedding
    volumes:
      - ./models/embedding:/models/embedding

  # LLMæœåŠ¡ï¼ˆGPUï¼‰
  llm-service:
    build: ./services/llm
    ports:
      - "8004:8000"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
    environment:
      - MODEL_PATH=/models/llm

  # å‘é‡æ•°æ®åº“
  qdrant:
    image: qdrant/qdrant:latest
    ports:
      - "6333:6333"
    volumes:
      - qdrant_data:/qdrant/storage

  # æ¶ˆæ¯é˜Ÿåˆ—
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data

volumes:
  qdrant_data:
  redis_data:
```

#### Kubernetes æ–¹æ¡ˆï¼ˆé€‚åˆå¤§è§„æ¨¡ï¼‰

```yaml
# k8s/deployment.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: document-api
spec:
  replicas: 3  # 3ä¸ªå‰¯æœ¬
  selector:
    matchLabels:
      app: document-api
  template:
    metadata:
      labels:
        app: document-api
    spec:
      containers:
      - name: document-api
        image: rag-system/document-api:latest
        ports:
        - containerPort: 8000
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"
---
apiVersion: v1
kind: Service
metadata:
  name: document-api
spec:
  selector:
    app: document-api
  ports:
  - port: 8000
    targetPort: 8000
  type: LoadBalancer
```

---

## âš¡ æ€§èƒ½ä¼˜åŒ–ç­–ç•¥

### 1. å¼‚æ­¥å¤„ç†

#### æ–‡æ¡£ä¸Šä¼ å¼‚æ­¥åŒ–
```python
# services/document/tasks.py
from celery import Celery

celery_app = Celery('document_tasks', broker='redis://redis:6379')

@celery_app.task
def process_document_async(document_id: str, file_path: str):
    """å¼‚æ­¥å¤„ç†æ–‡æ¡£"""
    # 1. PDFè§£æ
    # 2. æ–‡æœ¬åˆ†å—
    # 3. å‘é‡åŒ–ï¼ˆè°ƒç”¨EmbeddingæœåŠ¡ï¼‰
    # 4. å­˜å‚¨å‘é‡
    pass
```

#### æŸ¥è¯¢å¼‚æ­¥åŒ–
```python
# services/query/async_query.py
import asyncio
from concurrent.futures import ThreadPoolExecutor

async def process_query_async(query: str):
    """å¼‚æ­¥å¤„ç†æŸ¥è¯¢"""
    # å¹¶è¡Œè°ƒç”¨å¤šä¸ªæœåŠ¡
    embedding_task = asyncio.create_task(get_embedding(query))
    vector_search_task = asyncio.create_task(search_vectors(query))
    
    embedding, results = await asyncio.gather(
        embedding_task, vector_search_task
    )
    
    # è°ƒç”¨LLMç”Ÿæˆç­”æ¡ˆ
    answer = await generate_answer(query, results)
    return answer
```

### 2. ç¼“å­˜ç­–ç•¥

#### Redisç¼“å­˜
```python
# ç¼“å­˜å¸¸ç”¨æŸ¥è¯¢ç»“æœ
import redis
import json

redis_client = redis.Redis(host='redis', port=6379)

def get_cached_answer(query: str) -> Optional[str]:
    """è·å–ç¼“å­˜çš„ç­”æ¡ˆ"""
    cache_key = f"answer:{hash(query)}"
    cached = redis_client.get(cache_key)
    if cached:
        return json.loads(cached)
    return None

def cache_answer(query: str, answer: str, ttl: int = 3600):
    """ç¼“å­˜ç­”æ¡ˆ"""
    cache_key = f"answer:{hash(query)}"
    redis_client.setex(
        cache_key,
        ttl,
        json.dumps(answer)
    )
```

#### æ¨¡å‹ç¼“å­˜
- Embeddingæ¨¡å‹ï¼šä½¿ç”¨æ¨¡å‹æœåŠ¡ï¼Œå¤šå®ä¾‹å…±äº«
- LLMæ¨¡å‹ï¼šä½¿ç”¨vLLMç­‰æ¨ç†æ¡†æ¶ï¼Œæ”¯æŒå¹¶å‘æ¨ç†

### 3. æ‰¹é‡å¤„ç†

#### æ‰¹é‡å‘é‡åŒ–
```python
# services/embedding/batch.py
async def batch_embed(texts: List[str], batch_size: int = 32):
    """æ‰¹é‡å‘é‡åŒ–"""
    results = []
    for i in range(0, len(texts), batch_size):
        batch = texts[i:i+batch_size]
        embeddings = await embed_batch(batch)
        results.extend(embeddings)
    return results
```

### 4. è¿æ¥æ± 

#### æ•°æ®åº“è¿æ¥æ± 
```python
# ä½¿ç”¨è¿æ¥æ± ç®¡ç†æ•°æ®åº“è¿æ¥
from sqlalchemy import create_engine
from sqlalchemy.pool import QueuePool

engine = create_engine(
    "postgresql://...",
    poolclass=QueuePool,
    pool_size=20,
    max_overflow=40
)
```

#### HTTPå®¢æˆ·ç«¯è¿æ¥æ± 
```python
# ä½¿ç”¨httpxå¼‚æ­¥å®¢æˆ·ç«¯
import httpx

async with httpx.AsyncClient(
    limits=httpx.Limits(max_connections=100, max_keepalive_connections=20)
) as client:
    response = await client.get("http://embedding-service/embed", json={"text": text})
```

### 5. è´Ÿè½½å‡è¡¡

#### Nginxé…ç½®
```nginx
# nginx.conf
upstream embedding_service {
    least_conn;  # æœ€å°‘è¿æ¥è´Ÿè½½å‡è¡¡
    server embedding-service-1:8000;
    server embedding-service-2:8000;
    server embedding-service-3:8000;
}

upstream query_api {
    ip_hash;  # åŸºäºIPçš„ä¼šè¯ä¿æŒ
    server query-api-1:8000;
    server query-api-2:8000;
}

server {
    listen 80;
    
    location /api/v1/embedding/ {
        proxy_pass http://embedding_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
    
    location /api/v1/query/ {
        proxy_pass http://query_api;
    }
}
```

---

## ğŸ“Š ç›‘æ§ä¸å¯è§‚æµ‹æ€§

### 1. æŒ‡æ ‡ç›‘æ§ï¼ˆPrometheus + Grafanaï¼‰

```python
# æ·»åŠ PrometheusæŒ‡æ ‡
from prometheus_client import Counter, Histogram, Gauge

# è¯·æ±‚è®¡æ•°
request_count = Counter(
    'http_requests_total',
    'Total HTTP requests',
    ['method', 'endpoint', 'status']
)

# å“åº”æ—¶é—´
request_duration = Histogram(
    'http_request_duration_seconds',
    'HTTP request duration',
    ['method', 'endpoint']
)

# æ´»è·ƒè¿æ¥æ•°
active_connections = Gauge(
    'active_connections',
    'Number of active connections'
)
```

### 2. æ—¥å¿—èšåˆï¼ˆELK Stackï¼‰

```python
# ç»“æ„åŒ–æ—¥å¿—
import structlog

logger = structlog.get_logger()
logger.info(
    "query_processed",
    query="ç”¨æˆ·é—®é¢˜",
    duration=1.23,
    result_count=5,
    user_id="user123"
)
```

### 3. åˆ†å¸ƒå¼è¿½è¸ªï¼ˆJaeger / Zipkinï¼‰

```python
# æ·»åŠ è¿½è¸ª
from opentelemetry import trace
from opentelemetry.instrumentation.fastapi import FastAPIInstrumentor

tracer = trace.get_tracer(__name__)

@tracer.start_as_current_span("process_query")
async def process_query(query: str):
    with tracer.start_as_current_span("embedding"):
        embedding = await get_embedding(query)
    
    with tracer.start_as_current_span("vector_search"):
        results = await search_vectors(embedding)
    
    with tracer.start_as_current_span("llm_generate"):
        answer = await generate_answer(query, results)
    
    return answer
```

---

## ğŸ”„ å®æ–½è·¯çº¿å›¾

### é˜¶æ®µä¸€ï¼šåŸºç¡€ä¼˜åŒ–ï¼ˆ1-2å‘¨ï¼‰

#### 1.1 å¼‚æ­¥åŒ–æ”¹é€ 
- [ ] æ–‡æ¡£ä¸Šä¼ æ”¹ä¸ºå¼‚æ­¥å¤„ç†ï¼ˆCeleryï¼‰
- [ ] æŸ¥è¯¢æ¥å£æ”¹ä¸ºå¼‚æ­¥ï¼ˆasyncioï¼‰
- [ ] ä½¿ç”¨å¼‚æ­¥HTTPå®¢æˆ·ç«¯

#### 1.2 ç¼“å­˜å¼•å…¥
- [ ] é›†æˆRedisç¼“å­˜
- [ ] æŸ¥è¯¢ç»“æœç¼“å­˜
- [ ] æ¨¡å‹è¾“å‡ºç¼“å­˜

#### 1.3 è¿æ¥æ± ä¼˜åŒ–
- [ ] æ•°æ®åº“è¿æ¥æ± 
- [ ] HTTPè¿æ¥æ± 
- [ ] å‘é‡æ•°æ®åº“è¿æ¥æ± 

**é¢„æœŸæ•ˆæœ**ï¼š
- å¹¶å‘èƒ½åŠ›æå‡ 3-5å€
- å“åº”æ—¶é—´é™ä½ 30-50%

---

### é˜¶æ®µäºŒï¼šæœåŠ¡æ‹†åˆ†ï¼ˆ2-3å‘¨ï¼‰

#### 2.1 æ‹†åˆ†EmbeddingæœåŠ¡
- [ ] åˆ›å»ºç‹¬ç«‹çš„EmbeddingæœåŠ¡
- [ ] ä½¿ç”¨gRPCæˆ–HTTP API
- [ ] æ”¯æŒå¤šå®ä¾‹éƒ¨ç½²

#### 2.2 æ‹†åˆ†LLMæœåŠ¡
- [ ] åˆ›å»ºç‹¬ç«‹çš„LLMæœåŠ¡
- [ ] ä½¿ç”¨vLLMæˆ–ç±»ä¼¼æ¡†æ¶
- [ ] GPUèµ„æºéš”ç¦»

#### 2.3 æ‹†åˆ†æ–‡æ¡£æœåŠ¡
- [ ] æ–‡æ¡£ä¸Šä¼ æœåŠ¡ç‹¬ç«‹
- [ ] ä½¿ç”¨æ¶ˆæ¯é˜Ÿåˆ—å¤„ç†ä»»åŠ¡
- [ ] æ”¯æŒæ‰¹é‡å¤„ç†

**é¢„æœŸæ•ˆæœ**ï¼š
- æœåŠ¡å¯ç‹¬ç«‹æ‰©å±•
- èµ„æºåˆ©ç”¨ç‡æå‡ 50%
- æ•…éšœéš”ç¦»èƒ½åŠ›å¢å¼º

---

### é˜¶æ®µä¸‰ï¼šå®¹å™¨åŒ–éƒ¨ç½²ï¼ˆ1-2å‘¨ï¼‰

#### 3.1 DockeråŒ–
- [ ] ä¸ºæ¯ä¸ªæœåŠ¡åˆ›å»ºDockerfile
- [ ] Docker Composeç¼–æ’
- [ ] ç¯å¢ƒå˜é‡é…ç½®

#### 3.2 è´Ÿè½½å‡è¡¡
- [ ] Nginxé…ç½®
- [ ] æœåŠ¡å‘ç°
- [ ] å¥åº·æ£€æŸ¥

**é¢„æœŸæ•ˆæœ**ï¼š
- éƒ¨ç½²æ—¶é—´ä»å°æ—¶çº§é™åˆ°åˆ†é’Ÿçº§
- æ”¯æŒå¿«é€Ÿæ‰©å®¹

---

### é˜¶æ®µå››ï¼šKuberneteséƒ¨ç½²ï¼ˆ2-3å‘¨ï¼‰

#### 4.1 K8såŸºç¡€
- [ ] åˆ›å»ºDeploymentå’ŒService
- [ ] ConfigMapå’ŒSecretç®¡ç†
- [ ] Ingressé…ç½®

#### 4.2 è‡ªåŠ¨æ‰©ç¼©å®¹
- [ ] HPAï¼ˆHorizontal Pod Autoscalerï¼‰
- [ ] åŸºäºCPU/å†…å­˜çš„è‡ªåŠ¨æ‰©å®¹
- [ ] åŸºäºè¯·æ±‚é‡çš„è‡ªåŠ¨æ‰©å®¹

#### 4.3 é«˜å¯ç”¨
- [ ] å¤šå‰¯æœ¬éƒ¨ç½²
- [ ] Podåäº²å’Œæ€§
- [ ] æ•…éšœè‡ªæ„ˆ

**é¢„æœŸæ•ˆæœ**ï¼š
- æ”¯æŒå¤§è§„æ¨¡éƒ¨ç½²
- è‡ªåŠ¨æ‰©ç¼©å®¹
- é«˜å¯ç”¨æ€§ä¿éšœ

---

### é˜¶æ®µäº”ï¼šç›‘æ§ä¸ä¼˜åŒ–ï¼ˆæŒç»­ï¼‰

#### 5.1 ç›‘æ§ç³»ç»Ÿ
- [ ] PrometheusæŒ‡æ ‡æ”¶é›†
- [ ] Grafanaå¯è§†åŒ–
- [ ] å‘Šè­¦è§„åˆ™é…ç½®

#### 5.2 æ€§èƒ½ä¼˜åŒ–
- [ ] ç“¶é¢ˆåˆ†æ
- [ ] ä»£ç ä¼˜åŒ–
- [ ] èµ„æºè°ƒä¼˜

---

## ğŸ“ˆ æ€§èƒ½å¯¹æ¯”

### ä¼˜åŒ–å‰ï¼ˆå•ä½“æ¶æ„ï¼‰

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| å¹¶å‘è¯·æ±‚æ•° | 10-20 QPS |
| å¹³å‡å“åº”æ—¶é—´ | 2-5ç§’ |
| èµ„æºåˆ©ç”¨ç‡ | 30-40% |
| æ‰©å±•æ€§ | å·®ï¼ˆå•ç‚¹ï¼‰ |
| æ•…éšœå½±å“ | å…¨å±€ |

### ä¼˜åŒ–åï¼ˆå¾®æœåŠ¡+åˆ†å¸ƒå¼ï¼‰

| æŒ‡æ ‡ | æ•°å€¼ |
|------|------|
| å¹¶å‘è¯·æ±‚æ•° | 100-500+ QPS |
| å¹³å‡å“åº”æ—¶é—´ | 0.5-2ç§’ |
| èµ„æºåˆ©ç”¨ç‡ | 70-80% |
| æ‰©å±•æ€§ | ä¼˜ç§€ï¼ˆç‹¬ç«‹æ‰©å±•ï¼‰ |
| æ•…éšœå½±å“ | å±€éƒ¨éš”ç¦» |

---

## ğŸ› ï¸ æŠ€æœ¯é€‰å‹å»ºè®®

### æ¶ˆæ¯é˜Ÿåˆ—
- **Redis**ï¼šè½»é‡çº§ï¼Œé€‚åˆç®€å•ä»»åŠ¡é˜Ÿåˆ—
- **RabbitMQ**ï¼šåŠŸèƒ½å®Œæ•´ï¼Œé€‚åˆå¤æ‚åœºæ™¯
- **Kafka**ï¼šé«˜ååï¼Œé€‚åˆå¤§æ•°æ®æµ

### æœåŠ¡å‘ç°
- **Consul**ï¼šåŠŸèƒ½å®Œæ•´
- **etcd**ï¼šKubernetesåŸç”Ÿ
- **Zookeeper**ï¼šæˆç†Ÿç¨³å®š

### é…ç½®ç®¡ç†
- **Apollo**ï¼šåŠŸèƒ½å¼ºå¤§
- **Nacos**ï¼šé˜¿é‡Œå¼€æº
- **Kubernetes ConfigMap**ï¼šK8såŸç”Ÿ

### ç›‘æ§æ–¹æ¡ˆ
- **Prometheus + Grafana**ï¼šæŒ‡æ ‡ç›‘æ§
- **ELK Stack**ï¼šæ—¥å¿—åˆ†æ
- **Jaeger**ï¼šåˆ†å¸ƒå¼è¿½è¸ª

---

## ğŸ’° æˆæœ¬ä¼°ç®—

### å•ä½“æ¶æ„ï¼ˆå½“å‰ï¼‰
- æœåŠ¡å™¨ï¼š1å°ï¼ˆ8æ ¸16Gï¼‰â‰ˆ Â¥500/æœˆ
- æ€»è®¡ï¼šÂ¥500/æœˆ

### å¾®æœåŠ¡æ¶æ„ï¼ˆä¼˜åŒ–åï¼‰
- API Gatewayï¼š1å°ï¼ˆ2æ ¸4Gï¼‰â‰ˆ Â¥200/æœˆ
- Document Serviceï¼š2å°ï¼ˆ2æ ¸4Gï¼‰â‰ˆ Â¥400/æœˆ
- Query Serviceï¼š2å°ï¼ˆ2æ ¸4Gï¼‰â‰ˆ Â¥400/æœˆ
- Embedding Serviceï¼š3å°ï¼ˆ4æ ¸8Gï¼‰â‰ˆ Â¥1200/æœˆ
- LLM Serviceï¼š1å°ï¼ˆGPUï¼Œ8æ ¸32G+GPUï¼‰â‰ˆ Â¥3000/æœˆ
- å‘é‡æ•°æ®åº“ï¼š1å°ï¼ˆ4æ ¸8Gï¼‰â‰ˆ Â¥400/æœˆ
- Redisï¼š1å°ï¼ˆ2æ ¸4Gï¼‰â‰ˆ Â¥200/æœˆ
- **æ€»è®¡ï¼šÂ¥5800/æœˆ**

**æ³¨æ„**ï¼šæˆæœ¬å¢åŠ ä½†æ”¯æŒ10-50å€å¹¶å‘ï¼Œå•ä½æˆæœ¬æ›´ä½ã€‚

---

## ğŸ¯ æ¨èæ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šæ¸è¿›å¼ä¼˜åŒ–ï¼ˆæ¨èï¼‰
1. **ç¬¬ä¸€é˜¶æ®µ**ï¼šå¼‚æ­¥åŒ– + ç¼“å­˜ï¼ˆ1-2å‘¨ï¼‰
   - å¿«é€Ÿè§æ•ˆï¼Œæˆæœ¬ä½
   - å¹¶å‘èƒ½åŠ›æå‡3-5å€

2. **ç¬¬äºŒé˜¶æ®µ**ï¼šæ‹†åˆ†å…³é”®æœåŠ¡ï¼ˆ2-3å‘¨ï¼‰
   - EmbeddingæœåŠ¡ç‹¬ç«‹
   - LLMæœåŠ¡ç‹¬ç«‹

3. **ç¬¬ä¸‰é˜¶æ®µ**ï¼šå®¹å™¨åŒ–éƒ¨ç½²ï¼ˆ1-2å‘¨ï¼‰
   - Docker Compose
   - æ”¯æŒæ°´å¹³æ‰©å±•

### æ–¹æ¡ˆBï¼šå…¨é¢é‡æ„
- ä¸€æ¬¡æ€§å®Œæˆæ‰€æœ‰ä¼˜åŒ–
- é€‚åˆæœ‰å……è¶³æ—¶é—´å’Œèµ„æºçš„æƒ…å†µ

---

## ğŸ“š å‚è€ƒèµ„æº

- [FastAPIæœ€ä½³å®è·µ](https://fastapi.tiangolo.com/deployment/)
- [å¾®æœåŠ¡æ¶æ„æ¨¡å¼](https://microservices.io/patterns/)
- [Kuberneteså®˜æ–¹æ–‡æ¡£](https://kubernetes.io/docs/)
- [Prometheusç›‘æ§æŒ‡å—](https://prometheus.io/docs/)

---

*æœ€åæ›´æ–°æ—¶é—´ï¼š2026-01-02*

